// Copyright 2024 Audiotool Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package audiotool.project.v1;

import "audiotool/longrunning/v1/operation.proto";
import "audiotool/project/v1/project.proto";
import "audiotool/project/v1/session.proto";
import "google/api/field_behavior.proto";
import "google/api/resource.proto";
import "google/protobuf/field_mask.proto";

// The ProjectService provides methods to manage studio projects.
service ProjectService {
  // List the projects.option
  rpc ListProjects(ListProjectsRequest) returns (ListProjectsResponse) {}

  // Get a project.
  rpc GetProject(GetProjectRequest) returns (GetProjectResponse) {}

  // Create a project.
  rpc CreateProject(CreateProjectRequest) returns (CreateProjectResponse) {}

  // Upload a cover.
  rpc UploadCover(UploadCoverRequest) returns (UploadCoverResponse) {}

  // Update a project.
  rpc UpdateProject(UpdateProjectRequest) returns (UpdateProjectResponse) {}

  // Delete a project.
  rpc DeleteProject(DeleteProjectRequest) returns (DeleteProjectResponse) {}

  // SyncTrack a will create or update a track.
  //
  // The project will be used as leading source for the track.
  // This RPC kicks off a process where user can listen to via the events api.
  //
  // Another optimistic approach is to trigger GetTrack with the returned track_name.
  rpc SyncTrack(SyncTrackRequest) returns (audiotool.longrunning.v1.Operation) {}

  // Open a session. This will create a new session if one does not exist.
  //
  // This is used to allow multiple users to work on a project at the same time and opens the
  // Document. The returned session contains the URLs to connect to the DocumentService
  // which uses his own proto for communication. (audiotool.document.v1.DocumentService)
  rpc OpenSession(OpenSessionRequest) returns (OpenSessionResponse) {}

  // List sessions.
  //
  // This gives all the sessions where a user can join and are active at the request time.
  rpc ListSessions(ListSessionsRequest) returns (ListSessionsResponse) {}

  // Get Latest Version Bundle
  //
  // This returns the latest bundle version required for session to allow potential quicker pre-loading
  rpc GetLatestVersionBundle(GetLatestVersionBundleRequest) returns (GetLatestVersionBundleResponse) {}
}

// Request for ProjectService.ListProjects.
message ListProjectsRequest {
  // The standard CEL filter.
  //
  // Supported fields:
  // - project.name
  // - project.user_names
  // - project.creator_name
  // - project.track_name
  // - project.display_name
  // - project.description
  // - project.create_time
  // - project.update_time
  // - project.tags
  // - project.genre_name
  string filter = 1;

  // The maximum number of items to return.
  int32 page_size = 2;

  // The next_page_token value returned from a previous List request, if any.
  string page_token = 3;

  // The order to sort the results by.
  //
  // Supported fields:
  // - project.name
  // - project.user_names
  // - project.creator_name
  // - project.track_name
  // - project.display_name
  // - project.description
  // - project.create_time
  // - project.update_time
  // - project.tags
  // - project.genre_name
  string order_by = 4;
}

// Response for ProjectService.ListProjects.
message ListProjectsResponse {
  // The list of projects.
  repeated Project projects = 1;

  // Token to retrieve the next page of results, or empty if there are no more results in the
  // list.
  string next_page_token = 2;
}

// Request for ProjectService.GetProject.
message GetProjectRequest {
  // Required. The name of the project to get, in the form of `projects/{project_id}`.
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "project.api.audiotool.com/Project"}
  ];
}

// Response for ProjectService.GetProject.
message GetProjectResponse {
  // The project.
  Project project = 1;
}

// Request for ProjectService.CreateProject.
message CreateProjectRequest {
  // The project to create.
  Project project = 1 [(google.api.field_behavior) = REQUIRED];
}

// Response for ProjectService.CreateProject.
message CreateProjectResponse {
  // The created project.
  Project project = 1;
}

// Request for ProjectService.UploadCover.
message UploadCoverRequest {
  // Required. The name of the project to upload the cover, in the form of `projects/{project_id}`.
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "project.api.audiotool.com/Project"}
  ];

  // The image to upload. The data format will be automatically detected.
  // the following formats are supported:
  // - JPEG
  // - PNG
  // - WEBP
  bytes data = 2 [(google.api.field_behavior) = REQUIRED];
}

// Response for ProjectService.UploadCover.
message UploadCoverResponse {
  // The updated project.
  Project project = 1;
}

// Request for ProjectService.UpdateProject.
message UpdateProjectRequest {
  // The project to update.
  Project project = 1 [(google.api.field_behavior) = REQUIRED];

  // The update mask to apply to the project.
  google.protobuf.FieldMask update_mask = 2;
}

// Response for ProjectService.UpdateProject.
message UpdateProjectResponse {
  // The updated project.
  Project project = 1;
}

// Request for ProjectService.DeleteProject.
//
// If a track is associated with the project, the project can't be deleted. The track has to be
// deleted first.
//
// If another project was remixed of this project
message DeleteProjectRequest {
  // Required. The name of the project to be deleted, in the form of `projects/{project_id}`.
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "project.api.audiotool.com/Project"}
  ];
}

// Response for ProjectService.DeleteProject.
message DeleteProjectResponse {}

// SyncTrackMode defines the mode to sync a track.
enum SyncTrackMode {
  // Unspecified mode.
  SYNC_TRACK_MODE_UNSPECIFIED = 0;

  // Sync the tracks audio and metadata.
  SYNC_TRACK_MODE_ALL = 1;

  // Sync only the metadata of the track.
  SYNC_TRACK_MODE_METADATA = 2;

  // Sync only the audio of the track.
  SYNC_TRACK_MODE_AUDIO = 3;
}

// Request for ProjectService.SyncTrack.
message SyncTrackRequest {
  // Required. The name of the project to publish, in the form of `projects/{project_id}`.
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "project.api.audiotool.com/Project"}
  ];

  // Required. The mode to sync the track.
  SyncTrackMode mode = 2;

  // Commit index used to render the audio & images if mode is audio.
  uint32 commit_index = 3;
}

// Request for ProjectService.OpenSession.
message OpenSessionRequest {
  // Required. The name of the project to open a session for, in the form of `projects/{project_id}`.
  string project_name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "project.api.audiotool.com/Project"}
  ];
}

// Response for ProjectService.OpenSession.
message OpenSessionResponse {
  // The session.
  Session session = 1;
}

// Request for ProjectService.CloseSession.
message CloseSessionRequest {
  // Required. The name of the project to close the session for, in the form of `projects/{project_id}`.
  string project_name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "project.api.audiotool.com/Project"}
  ];
}

// Response for ProjectService.CloseSession.
message CloseSessionResponse {}

// Request for ProjectService.ListSession.
//
// List sessions of where a user can join.
message ListSessionsRequest {
  // The standard CEL filter.
  //
  // Supported fields:
  // - session.project_name
  string filter = 1;

  // The maximum number of items to return.
  int32 page_size = 2;

  // The next_page_token value returned from a previous List request, if any.
  string page_token = 3;

  // The order to sort the results by.
  //
  // Supported fields:
  // - session.project_name
  string order_by = 4;
}

// Response for ProjectService.ListSessions.
message ListSessionsResponse {
  // The list of sessions.
  repeated Session sessions = 1;
}

// Request for ProjectService.GetLatestVersionBundle
message GetLatestVersionBundleRequest {}

// Response for ProjectService.GetLatestVersionBundle
message GetLatestVersionBundleResponse {
  // The prefix URL for studio (location of assets in the CDN).
  string studio_prefix_url = 1;

  // The prefix URL for document_service (location of assets in the CDN).
  //
  // Within this location is the document_validator.wasm
  string document_service_prefix_url = 2;

  // The prefix URL for the audio engine (location of assets in the CDN).
  string audio_engine_prefix_url = 3;
}
